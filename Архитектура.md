# Архитектура: RetailCRM — Анализ работы менеджеров

> Связано: [ТЗ](ТЗ_выгрузка_чатов_RetailCRM.md) | [Бэклог](Бэклог.md) | 

---

## Общая схема системы

```
┌─────────────────────────────────────────────────────┐
│              RetailCRM (источник)                   │
│  - Папка "Чаты"                                     │
│  - Каналы: WhatsApp, Instagram                      │
│  - API: /customers/chats, /messages                 │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│           Скрипты выгрузки (Python)                 │
│  - complete_export.py (полная выгрузка)             │
│  - export_to_sheets.py (экспорт в Google Sheets)    │
│  - export_to_sheets_batch.py (батчами)              │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│         Промежуточная обработка (Python)            │
│  - retailcrm_client.py (клиент API)                 │
│  - analysis_rules.py (правила анализа)              │
│  - dialog_templates.py (шаблоны диалогов)           │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│              SPIN-анализ (Python)                   │
│  - spin_analysis.py (анализ по методике SPIN)       │
│  - spin_conversion_analysis.py (конверсия)          │
│  - quality_chats_analysis.py (качество чатов)       │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│           Google Sheets (витрина данных)            │
│  Вкладки:                                           │
│  1. chats_raw (сырые данные чатов)                  │
│  2. messages_raw (сырые данные сообщений)           │
│  3. manager_summary (сводка по менеджерам)          │
│  4. channel_summary (сводка по каналам)             │
│  5. chat_advice (советы по каждому чату)            │
│  6. spin_manager_metrics (SPIN по менеджерам)       │
│  7. spin_chat_metrics (SPIN по чатам)               │
│  8. spin_improvement_plans (планы улучшения)        │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│          Отчёты и уведомления                       │
│  - daily_report.py (ежедневный отчёт)               │
│  - weekly_digest.py (еженедельный дайджест)         │
│  - telegram_daily_report.py (в Telegram)            │
│  - behavior_digest.py (дайджест поведения)          │
└─────────────────────────────────────────────────────┘
```

---

## Компоненты системы

### 1. Источник данных (RetailCRM)

**API RetailCRM:**
- **Чаты:** `/customers/chats`
- **Сообщения:** `/messages`

**Каналы:**
- WhatsApp
- Instagram

**Клиент:** [retailcrm_client.py](retailcrm_client.py)

---

### 2. Выгрузка данных (Python скрипты)

#### Основные скрипты:
- **[complete_export.py](complete_export.py)** — полная выгрузка за период
- **[export_to_sheets.py](export_to_sheets.py)** — экспорт в Google Sheets
- **[export_to_sheets_batch.py](export_to_sheets_batch.py)** — батч-экспорт (для больших объёмов)

#### Вспомогательные:
- **[check_data.py](check_data.py)** — проверка данных
- **[check_order_data.py](check_order_data.py)** — проверка заказов
- **[check_real_data.py](check_real_data.py)** — проверка реальных данных

---

### 3. Анализ данных

#### SPIN-анализ (методика SPIN-продаж Нила Рэкхема)

**4 этапа SPIN:**
1. **S (Situation)** — ситуационные вопросы
2. **P (Problem)** — проблемные вопросы
3. **I (Implication)** — извлекающие вопросы (последствия проблемы)
4. **N (Need-payoff)** — направляющие вопросы (выгоды решения)

**Скрипты:**
- **[spin_analysis.py](spin_analysis.py)** — основной анализ SPIN
- **[spin_conversion_analysis.py](spin_conversion_analysis.py)** — конверсия по SPIN
- **[quality_chats_analysis.py](quality_chats_analysis.py)** — качество чатов

**Выходные данные:**
- **spin_manager_metrics** — метрики по менеджерам
- **spin_chat_metrics** — метрики по чатам
- **spin_improvement_plans** — планы улучшения
- **[План_улучшения_SPIN.md](План_улучшения_SPIN.md)** — документ с рекомендациями

---

#### Другие виды анализа:
- **[analysis_rules.py](analysis_rules.py)** — правила анализа (советы по чатам)
- **[behavior_digest.py](behavior_digest.py)** — дайджест поведения менеджеров
- **[manager_report.py](manager_report.py)** — отчёт по менеджерам
- **[question_type_analysis.py](question_type_analysis.py)** — анализ типов вопросов
- **[best_practices_analysis.py](best_practices_analysis.py)** — best practices

---

### 4. Google Sheets (витрина данных)

**Структура листов:**

#### Лист 1: `chats_raw` (сырые данные чатов)
Колонки:
- `chat_id`, `channel`, `manager_id`, `manager_name`
- `client_id`, `order_id`
- `created_at`, `updated_at`, `status`
- `inbound_count`, `outbound_count`
- `first_response_sec`, `unanswered_inbound`

#### Лист 2: `messages_raw` (сырые данные сообщений)
Колонки:
- `chat_id`, `message_id`, `sent_at`
- `direction` (in/out)
- `manager_id`, `text`

#### Лист 3: `manager_summary` (сводка по менеджерам)
Метрики:
- Количество чатов, сообщений (вход/выход)
- Безответные входящие
- Медиана и P90 времени первого ответа
- Response rate

#### Лист 4: `channel_summary` (сводка по каналам)
Метрики по каналам (WhatsApp/Instagram)

#### Лист 5: `chat_advice` (советы по каждому чату)
Автоматические рекомендации:
- "Нет ответа менеджера"
- "Сократить время реакции"
- "Добавить follow-up"
- "Добавить уточняющие вопросы"
- "Дать next step"

#### Лист 6-8: SPIN-метрики
- `spin_manager_metrics` — по менеджерам
- `spin_chat_metrics` — по чатам
- `spin_improvement_plans` — планы улучшения

**Скрипт работы с Sheets:** [sheets.py](sheets.py)

---

### 5. Отчёты и уведомления

#### Ежедневные отчёты:
- **[daily_report.py](daily_report.py)** — ежедневный отчёт
- **[telegram_daily_report.py](telegram_daily_report.py)** — отчёт в Telegram
- **Запуск:** [run_daily.sh](run_daily.sh)

#### Еженедельные отчёты:
- **[weekly_digest.py](weekly_digest.py)** — еженедельный дайджест
- **[weekly_metrics_analysis.py](weekly_metrics_analysis.py)** — анализ метрик
- **[send_weekly_telegram.py](send_weekly_telegram.py)** — в Telegram
- **Запуск:** [run_weekly.sh](run_weekly.sh)

#### Дайджест поведения:
- **[behavior_digest.py](behavior_digest.py)** — анализ поведения менеджеров
- **[order_payment_analysis.py](order_payment_analysis.py)** — анализ оплат заказов

---

### 6. Автоматизация

#### Launchd (macOS):
- **Папка:** [launchd/](launchd/)
- **Назначение:** Автоматический запуск отчётов (ежедневно/еженедельно)

#### Railway (облачный деплой):
- **Инструкция:** [ИНСТРУКЦИЯ_деплой_Railway.md](ИНСТРУКЦИЯ_деплой_Railway.md)
- **Быстрый старт:** [RAILWAY_БЫСТРЫЙ_СТАРТ.md](RAILWAY_БЫСТРЫЙ_СТАРТ.md)
- **Конфиг:** [railway.json](railway.json)
- **Procfile:** [Procfile](Procfile)
- **Скрипт:** [run_railway.py](run_railway.py)

---

## Технологический стек

### Backend
- **Python 3.9+**
- **Библиотеки:**
  - `requests` — API-запросы к RetailCRM
  - `gspread` / `google-auth` — работа с Google Sheets
  - `python-telegram-bot` — уведомления в Telegram

### Хранение данных
- **Google Sheets** — витрина данных
- **RetailCRM** — источник истины

### Автоматизация
- **Launchd** (macOS) — локальный запуск
- **Railway** — облачный деплой

### Конфигурация
- **env** / **env.example** — переменные окружения

---

## Правила анализа (MVP)

### Метрики времени ответа:
- **Время первого ответа:** разница между первым входящим и первым исходящим
- **Slow first reply:** первый ответ > 10 минут
- **Рабочие часы:** 10:00–23:00

### Метрики качества:
- **Потерянные входящие:** входящие после последнего исходящего (эвристика)
- **Response rate:** % чатов с ответом менеджера
- **Unanswered inbound:** количество безответных входящих

### Советы (rule-based):
1. **Нет исходящих при наличии входящих** → "нет ответа менеджера"
2. **Первый ответ > 10 минут** → "сократить время реакции"
3. **Входящие после последнего исходящего** → "follow-up + зафиксировать следующий шаг"
4. **В первых исходящих нет вопроса** → "добавить уточняющие вопросы"
5. **Клиент спрашивает цену/наличие/покупку, но нет next step** → "дать next step"

---

## Деплой и запуск

### Локальный запуск (macOS):
```bash
# Полная выгрузка
python3 complete_export.py

# Экспорт в Google Sheets
python3 export_to_sheets.py

# Ежедневный отчёт
./run_daily.sh

# Еженедельный отчёт
./run_weekly.sh
```

### Railway (облачный):
1. Настроить переменные окружения (см. [ИНСТРУКЦИЯ_деплой_Railway.md](ИНСТРУКЦИЯ_деплой_Railway.md))
2. Деплой:
   ```bash
   railway up
   ```
3. Запуск:
   ```bash
   python3 run_railway.py
   ```

---

## Зафиксированные решения

- **Каналы:** WhatsApp + Instagram
- **Источник:** Папка «Чаты» в RetailCRM
- **Аналитика:** по менеджерам
- **Формат выгрузки:** Google Sheets
- **Режим:** разовая выгрузка за 2–3 месяца (с возможностью регулярной)
- **Рабочие часы:** 10:00–23:00
- **SPIN-анализ:** 4 этапа (S-P-I-N) по методике Нила Рэкхема

---

## Открытые вопросы

1. **RETAILCRM_URL** (домен) и ограничения IP/доступа к API?
2. **Модуль WhatsApp/Instagram:** native / I2CRM / другое?
3. **Часовой пояс:** подтвердить для корректной оценки времени реакции
4. **Частота обновления:** разовая или регулярная (ежедневно/еженедельно)?

---

## Связанные файлы

- [ТЗ](ТЗ_выгрузка_чатов_RetailCRM.md) — полное ТЗ проекта
- [Бэклог](Бэклог.md) — задачи с приоритетами
- [README.md](README.md) — общая документация
- [ИНСТРУКЦИЯ_деплой_Railway.md](ИНСТРУКЦИЯ_деплой_Railway.md) — деплой на Railway
- [План_улучшения_SPIN.md](План_улучшения_SPIN.md) — рекомендации по SPIN
- [РЕЗЮМЕ_системы.md](РЕЗЮМЕ_системы.md) — краткое резюме
- [Задачи.md](../../../../Задачи.md) — канбан проекта
